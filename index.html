<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üî• MTurk Accepted HITs ‚Äì Live + Support</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: #f8fafc;
      color: #111827;
      padding: 24px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    h1 {
      color: #0f62fe;
      margin: 0;
      font-size: 26px;
      flex: 1;
    }
    #ticketBtn {
      background: #dc2626;
      color: #000;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      transition: transform 0.1s ease-in-out;
    }
    #ticketBtn:hover { transform: scale(1.05); }

    #onlineCount {
      text-align: center;
      color: #6b7280;
      margin-bottom: 12px;
      font-size: 14px;
    }
    #enableNotif {
      display: block;
      margin: 0 auto 20px auto;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
      font-size: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      background: #0f62fe;
      color: white;
      font-weight: 600;
    }
    tr:hover { background: #f1f5f9; }

    .footer {
      text-align: center;
      margin-top: 12px;
      color: #6b7280;
      font-size: 13px;
    }

    /* --- Modal --- */
    #ticketModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      align-items: center; justify-content: center;
      z-index: 9999;
    }
    .modal-content {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
    }
    .modal-content h2 {
      margin-top: 0;
      text-align: center;
      color: #0f62fe;
    }
    .modal-content input,
    .modal-content textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
    }
    .modal-content label {
      font-size: 13px;
      color: #374151;
    }
    .close {
      float: right;
      font-size: 20px;
      cursor: pointer;
    }
    #recordAudio {
      background: #0f766e;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>üî• MTurk Accepted HITs ‚Äì Live Monitor</h1>
    <button id="ticketBtn">üìù Raise Support Ticket</button>
  </header>

  <span id="onlineCount">0 online</span>
  <button id="enableNotif">Enable notifications</button>

  <table>
    <thead>
      <tr>
        <th>Requester</th>
        <th>Title</th>
        <th>Reward ($)</th>
        <th>Accepted At</th>
      </tr>
    </thead>
    <tbody id="hits-body"></tbody>
  </table>

  <div class="footer">
    Real-time HIT monitor ‚Ä¢ Sound + Desktop notifications when new HIT arrives
  </div>

  <!-- Ticket Modal -->
  <div id="ticketModal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Raise Support Ticket</h2>

      <label>User ID</label>
      <input id="userId" placeholder="Enter your User ID (e.g. User218)" required>

      <label>Issue Title</label>
      <input id="issueTitle" placeholder="Example: Payment delay or task error">

      <label>Description</label>
      <textarea id="issueDesc" rows="3" placeholder="Describe your issue clearly..."></textarea>

      <label>Attach image / PDF (optional)</label>
      <input type="file" id="issueFiles" multiple accept="image/*,.pdf">

      <button id="recordAudio">üéôÔ∏è Record Audio</button>
      <p id="recordStatus" style="font-size:12px;color:#6b7280;margin-top:4px;">(optional)</p>

      <button id="submitTicket" style="background:#2563eb;color:white;border:none;border-radius:6px;padding:8px 12px;margin-top:10px;width:100%;">
        Submit
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot, addDoc, serverTimestamp, doc, setDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDIo2TPyxFs1BP_AaeQ6mMvqKXgQorQsS0",
      authDomain: "taskmonitor-7bc94.firebaseapp.com",
      projectId: "taskmonitor-7bc94",
      storageBucket: "taskmonitor-7bc94.firebasestorage.app",
      messagingSenderId: "294318327155",
      appId: "1:294318327155:web:e0fd12d1afac85f0bbb106"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // === Live HIT Monitor ===
    const tableBody=document.querySelector("#hits-body");
    const soundUrl="https://www.allbyjohn.com/sounds/mturkscanner/lessthan15Short.mp3";
    const playSound=()=>{const a=new Audio(soundUrl);a.volume=0.7;a.play().catch(()=>{});};
    const knownIds=new Set();

    function renderTable(hits){
      tableBody.innerHTML="";
      hits.sort((a,b)=>new Date(b.acceptedAt)-new Date(a.acceptedAt));
      for(const h of hits){
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${h.requester||"-"}</td>
          <td>${h.title||"-"}</td>
          <td>${h.reward||"0.00"}</td>
          <td>${h.acceptedAt?new Date(h.acceptedAt).toLocaleString():"-"}</td>`;
        tableBody.appendChild(tr);
      }
    }

    setTimeout(()=>{
      onSnapshot(collection(db,"hits"),(snapshot)=>{
        const hits=[],newIds=new Set();
        snapshot.forEach(docSnap=>{
          const d=docSnap.data();hits.push(d);
          if(d.assignmentId)newIds.add(d.assignmentId);
        });
        const added=[...newIds].filter(id=>!knownIds.has(id));
        if(added.length>0)playSound();
        knownIds.clear();newIds.forEach(id=>knownIds.add(id));
        renderTable(hits);
      });
    },1500);

    // === Presence Counter ===
    const onlineEl=document.querySelector("#onlineCount");
    const presenceCol=collection(db,"rooms/index/presence");
    const sid=crypto.randomUUID?.()??Math.random().toString(36).slice(2);
    const meRef=doc(presenceCol,sid);
    setDoc(meRef,{since:serverTimestamp(),lastActive:serverTimestamp()},{merge:true});
    const hb=setInterval(()=>setDoc(meRef,{lastActive:serverTimestamp()},{merge:true}),60000);
    window.addEventListener("beforeunload",()=>{clearInterval(hb);deleteDoc(meRef);});
    onSnapshot(presenceCol,(snap)=>{
      const now=Date.now();let count=0;
      snap.forEach(d=>{
        const t=d.data()?.lastActive;
        const ms=t?.toMillis?.()??(t?Date.parse(t):0);
        if(ms&&(now-ms)<=90000)count++;
      });
      onlineEl.textContent=`${count} online`;
    });

    // === Notifications ===
    const notifBtn=document.getElementById("enableNotif");
    notifBtn.addEventListener("click",async()=>{
      if("Notification" in window)await Notification.requestPermission();
      notifBtn.style.display="none";
    });
    if("Notification" in window && Notification.permission==="granted")notifBtn.style.display="none";

    // === Ticket Modal ===
    const modal=document.getElementById("ticketModal");
    document.getElementById("ticketBtn").onclick=()=>modal.style.display="flex";
    document.querySelector(".close").onclick=()=>modal.style.display="none";
    window.onclick=e=>{if(e.target===modal)modal.style.display="none";};

    // === Audio Recorder ===
    let recorder,chunks=[],audioBlob=null;
    const recBtn=document.getElementById("recordAudio"),recStat=document.getElementById("recordStatus");
    recBtn.onclick=async()=>{
      if(!recorder||recorder.state==="inactive"){
        const stream=await navigator.mediaDevices.getUserMedia({audio:true});
        recorder=new MediaRecorder(stream);
        recorder.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data);};
        recorder.onstop=()=>{
          audioBlob=new Blob(chunks,{type:"audio/webm"});chunks=[];
          recStat.textContent="‚úÖ Recorded successfully ‚Äì will upload";
        };
        recorder.start();
        recStat.textContent="üéôÔ∏è Recording‚Ä¶ click again to stop";
      }else{recorder.stop();}
    };

    async function uploadFile(f,path="tickets"){const r=ref(storage,`${path}/${Date.now()}_${f.name}`);await uploadBytes(r,f);return getDownloadURL(r);}
    async function uploadAudio(){if(!audioBlob)return"";const f=new File([audioBlob],"record.webm",{type:"audio/webm"});return uploadFile(f,"tickets/audio");}

    document.getElementById("submitTicket").onclick=async()=>{
      const userId=document.getElementById("userId").value.trim();
      const title=document.getElementById("issueTitle").value.trim();
      const desc=document.getElementById("issueDesc").value.trim();
      const files=document.getElementById("issueFiles").files;
      if(!userId||!desc){alert("Please enter your User ID and issue description.");return;}
      const fileUrls=[];for(const f of files){fileUrls.push(await uploadFile(f));}
      const audioUrl=await uploadAudio();
      await addDoc(collection(db,"support_tickets"),{
        userId,
        subject:title||"(no title)",
        description:desc,
        attachments:fileUrls,
        audioUrl,
        status:"open",
        createdAt:serverTimestamp()
      });
      alert(`‚úÖ Ticket submitted successfully for ${userId}`);
      modal.style.display="none";
      document.getElementById("userId").value="";
      document.getElementById("issueTitle").value="";
      document.getElementById("issueDesc").value="";
      document.getElementById("issueFiles").value=null;
      audioBlob=null;recStat.textContent="(optional)";
    };
  </script>
</body>
</html>
