<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ’° MTurk Earnings Monitor</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { initializeFirestore, collection, getDocs } from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ================= FIREBASE ================= */
const cfg = {
  apiKey: "AIzaSyBTFpM3fs7kWBrZL4yOi9tquUTp1HhH7L8",
  authDomain: "mturk-monitordeep.firebaseapp.com",
  projectId: "mturk-monitordeep",
  appId: "1:505786000194:web:40b9c9df75d3125f3a99cd"
};

const app = initializeApp(cfg);
const db = initializeFirestore(app, {
  experimentalForceLongPolling: true,
  useFetchStreams: false
});

/* ================= CONSTANTS ================= */
const CACHE_KEY = "earnings_daily_cache";
const TRANSFER_KEY = "earnings_transfers_cache";
const SYNC_KEY = "earnings_sync_day";

/* ================= HELPERS ================= */
const today = () => new Date().toISOString().slice(0,10);

function after5th(dateStr){
  const d = new Date(dateStr);
  return d.getDate() > 5;
}

function activeUntil6th(dateStr){
  const d = new Date(dateStr);
  const expiry = new Date(d.getFullYear(), d.getMonth()+1, 6);
  return new Date() < expiry;
}

function needsSync(){
  return localStorage.getItem(SYNC_KEY) !== today();
}

/* ================= LOAD TEAM SHEET ================= */
async function loadTeamCSV(){
  const res = await fetch(
    "https://docs.google.com/spreadsheets/d/1mf2-AQ59CuboAWz8Fle3qXTFfAI3cnB7mrkqQF1lyCw/export?format=csv&gid=0"
  );
  const text = await res.text();
  const lines = text.split("\n").filter(Boolean);

  const users = new Set(), workers = new Set();
  for(let i=1;i<lines.length;i++){
    const [u,w] = lines[i].split(",");
    if(u) users.add(u.trim());
    if(w) workers.add(w.trim());
  }
  return { users, workers };
}

/* ================= FIRESTORE (DAILY) ================= */
async function loadFirestore(){
  const snap = await getDocs(collection(db,"earnings_logs"));
  const arr = [];
  snap.forEach(d=>arr.push(d.data()));
  localStorage.setItem(CACHE_KEY, JSON.stringify(arr));
  localStorage.setItem(SYNC_KEY, today());
  return arr;
}

/* ================= TRANSFER CACHE ================= */
function loadTransfers(){
  return JSON.parse(localStorage.getItem(TRANSFER_KEY)||"[]")
    .filter(t=>activeUntil6th(t.date));
}

function saveTransfers(list){
  localStorage.setItem(TRANSFER_KEY, JSON.stringify(list));
}

function refreshTransfers(docs, users, workers){
  let cache = loadTransfers();

  for(const d of docs){
    const user = (d.user||"").trim();
    const wid = (d.workerId||"").trim();

    if(!users.has(user) && !workers.has(wid)) continue;

    const amt = parseFloat(d.lastTransferAmount)||0;
    const date = d.lastTransferDate;
    if(amt<8 || !date || !after5th(date) || !activeUntil6th(date)) continue;

    const exists = cache.some(t =>
      t.user===user && t.workerId===wid && t.amount===amt && t.date===date
    );

    if(!exists){
      cache.push({user, workerId:wid, amount:amt, date});
    }
  }
  saveTransfers(cache);
  return cache;
}

/* ================= BUILD DATA ================= */
async function buildData(){
  const loading = document.getElementById("loading");
  loading.style.display="block";

  const {users,workers} = await loadTeamCSV();
  const docs = needsSync()? await loadFirestore() :
               JSON.parse(localStorage.getItem(CACHE_KEY)||"[]");

  const transfers = refreshTransfers(docs, users, workers);

  let qTotal=0, tTotal=0;
  const qBody = document.getElementById("qualifiedBody");
  const tBody = document.getElementById("transferBody");
  qBody.innerHTML=""; tBody.innerHTML="";

  for(const d of docs){
    const user=(d.user||"").trim();
    const wid=(d.workerId||"").trim();
    const cur=parseFloat(d.currentEarnings)||0;
    if(cur>=8 && (users.has(user)||workers.has(wid))){
      qTotal+=cur;
      qBody.innerHTML+=`<tr><td>${user}</td><td>${wid}</td><td>$${cur.toFixed(2)}</td></tr>`;
    }
  }

  for(const t of transfers){
    tTotal+=t.amount;
    tBody.innerHTML+=`<tr><td>${t.user}</td><td>${t.workerId}</td><td>$${t.amount.toFixed(2)}</td><td>${t.date}</td></tr>`;
  }

  document.getElementById("total").innerHTML =
    `Qualified (â‰¥$8) + Transfers(after 5th): <b>$${(qTotal+tTotal).toFixed(2)}</b>`;

  loading.style.display="none";
}

/* ================= INIT ================= */
buildData();
</script>

<style>
body{font-family:Segoe UI;background:#f8fafc;padding:20px}
h1{text-align:center;color:#0f62fe}
#total{text-align:center;font-size:18px;margin:10px}
table{width:95%;margin:10px auto;background:white;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #e5e7eb}
th{background:#0f62fe;color:white}
</style>
</head>

<body>
<h1>ðŸ’° MTurk Earnings Monitor</h1>
<div id="loading">Loadingâ€¦</div>
<div id="total"></div>

<h3>Qualified Users</h3>
<table><thead><tr><th>User</th><th>Worker</th><th>Current</th></tr></thead>
<tbody id="qualifiedBody"></tbody></table>

<h3>Transferred (after 5th, locked till 6th)</h3>
<table><thead><tr><th>User</th><th>Worker</th><th>Amount</th><th>Date</th></tr></thead>
<tbody id="transferBody"></tbody></table>
</body>
</html>
