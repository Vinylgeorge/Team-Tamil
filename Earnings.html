<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ’° MTurk Earnings Monitor (Qualified + Transferred)</title>

<!-- SheetJS for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script type="module">
/* ======================================================
   FIREBASE IMPORTS
====================================================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  initializeFirestore,
  collection,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ======================================================
   FIREBASE CONFIG
====================================================== */
const earningsConfig = {
  apiKey: "AIzaSyBTFpM3fs7kWBrZL4yOi9tquUTp1HhH7L8",
  authDomain: "mturk-monitordeep.firebaseapp.com",
  projectId: "mturk-monitordeep",
  storageBucket: "mturk-monitordeep.firebasestorage.app",
  messagingSenderId: "505786000194",
  appId: "1:505786000194:web:40b9c9df75d3125f3a99cd"
};

const earningsApp = initializeApp(earningsConfig, "earningsApp");
const earningsDB  = initializeFirestore(earningsApp, {
  experimentalForceLongPolling: true,
  useFetchStreams: false
});

/* ======================================================
   CONSTANTS + STATE
====================================================== */
const CACHE_KEY = "earnings_cache_data";

let QUALIFIED_DATA   = [];
let TRANSFERRED_DATA = [];

/* ======================================================
   HELPERS
====================================================== */
function today() {
  return new Date().toISOString().slice(0, 10);
}

// Only fetch Firestore once ever
function needsSync() {
  return !localStorage.getItem(CACHE_KEY);
}

// Parse MM/DD/YY format
function parseMDY(dateStr) {
  if (!dateStr) return null;
  const p = dateStr.split("/");
  if (p.length !== 3) return null;
  const m = +p[0], d = +p[1], y = 2000 + +p[2];
  if (isNaN(m) || isNaN(d) || isNaN(y)) return null;
  return { m, d, y };
}

/* ======================================================
   TRANSFER FILTER:
   Previous month (dayâ‰¥6) + Current month (dayâ‰¤6)
====================================================== */
function includeTransfer(dateStr) {
  const parsed = parseMDY(dateStr);
  if (!parsed) return false;

  const now = new Date();
  const CM  = now.getMonth() + 1;
  const CY  = now.getFullYear();
  const PM  = CM === 1 ? 12 : CM - 1;
  const PY  = CM === 1 ? CY - 1 : CY;

  // Previous month
  if (parsed.m === PM && parsed.y === PY && parsed.d >= 6) return true;

  // Current month
  if (parsed.m === CM && parsed.y === CY && parsed.d <= 6) return true;

  return false;
}

/* ======================================================
   LOAD MAIN CSV (Users + Worker IDs)
====================================================== */
async function loadMainCSV() {
  const res   = await fetch("https://docs.google.com/spreadsheets/d/17eUr3eictd9yMNhLyGyBUl9ozBppiot8raaoj_mjvQM/export?format=csv&gid=0");
  const text  = await res.text();
  const lines = text.split("\n").filter(Boolean);

  const users   = new Set();
  const workers = new Set();

  for (let i = 1; i < lines.length; i++) {
    const [u, w] = lines[i].split(",");
    if (u) users.add(u.trim());
    if (w) workers.add(w.trim());
  }
  return { users, workers };
}

/* ======================================================
   FIRESTORE SNAPSHOT (ONLY ONCE EVER)
====================================================== */
async function fetchFromFirestore() {
  const snap = await getDocs(collection(earningsDB, "earnings_logs"));
  const arr  = [];
  snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
  localStorage.setItem(CACHE_KEY, JSON.stringify(arr));
  return arr;
}

function loadCache() {
  return JSON.parse(localStorage.getItem(CACHE_KEY) || "[]");
}

/* ======================================================
   COUNTDOWN (Cosmetic)
====================================================== */
function updateCountdown() {
  const nextSyncEl = document.getElementById("next-sync");
  if (!nextSyncEl) return;

  nextSyncEl.innerHTML = `Snapshot Loaded: <b>${today()}</b>`;
}

/* ======================================================
   BUILD DATA
====================================================== */
async function buildData() {
  const loadingEl = document.getElementById("loading");
  const totalQEl  = document.getElementById("totalQualified");
  const totalTEl  = document.getElementById("totalTransferred");

  loadingEl.style.display = "block";

  const { users, workers } = await loadMainCSV();
  const all = needsSync() ? await fetchFromFirestore() : loadCache();

  QUALIFIED_DATA   = [];
  TRANSFERRED_DATA = [];

  let qualifiedSum  = 0;
  let transferSum   = 0;

  for (const d of all) {
    const user = (d.user || "").trim();
    const wid  = (d.workerId || "").trim();

    if (!users.has(user) && !workers.has(wid)) continue;

    const current  = parseFloat(d.currentEarnings) || 0;
    const lt       = parseFloat(d.lastTransferAmount) || 0;
    const lastDate = d.lastTransferDate || "";
    const nextDate = d.nextTransferDate || "â€”";

    // Qualified users
    if (current >= 8) {
      QUALIFIED_DATA.push({ user, wid, current, nextDate });
      qualifiedSum += current;
    }

    // Transferred filter
    if (lt >= 8 && includeTransfer(lastDate)) {
      TRANSFERRED_DATA.push({ user, wid, amount: lt, date: lastDate });
      transferSum += lt;
    }
  }

  // Sort descending
  QUALIFIED_DATA.sort((a, b) => b.current - a.current);
  TRANSFERRED_DATA.sort((a, b) => b.amount - a.amount);

  totalQEl.innerHTML =
    `Qualified Users (â‰¥ $8): <b>$${qualifiedSum.toFixed(2)}</b> (${QUALIFIED_DATA.length} users)`;

  totalTEl.innerHTML =
    `Transferred (Prevâ‰¥6 & Currâ‰¤6): <b>$${transferSum.toFixed(2)}</b> (${TRANSFERRED_DATA.length} users)`;

  renderQualifiedTable();
  initTransferredFilterAndTable();
  loadingEl.style.display = "none";
}

/* ======================================================
   RENDER â€“ QUALIFIED
====================================================== */
function renderQualifiedTable() {
  const tbody = document.getElementById("qualified-body");
  tbody.innerHTML = "";

  for (const r of QUALIFIED_DATA) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.user}</td>
      <td>${r.wid}</td>
      <td style="color:#15803d;font-weight:bold">${r.current.toFixed(2)}</td>
      <td>${r.nextDate}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ======================================================
   RENDER â€“ TRANSFERRED + Date Filter
====================================================== */
function initTransferredFilterAndTable() {
  const select = document.getElementById("transferDateFilter");

  const dates = Array.from(new Set(TRANSFERRED_DATA.map(r => r.date)))
    .sort((a, b) => new Date(a) - new Date(b));

  select.innerHTML = `<option value="">All Dates</option>`;
  dates.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    select.appendChild(opt);
  });

  select.onchange = renderTransferredTable;
  renderTransferredTable();
}

function renderTransferredTable() {
  const tbody     = document.getElementById("transferred-body");
  const filterVal = document.getElementById("transferDateFilter").value;

  tbody.innerHTML = "";

  const data = TRANSFERRED_DATA.filter(r =>
    !filterVal || r.date === filterVal
  );

  for (const r of data) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.user}</td>
      <td>${r.wid}</td>
      <td style="color:#b91c1c;font-weight:bold">${r.amount.toFixed(2)}</td>
      <td>${r.date}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ======================================================
   EXCEL EXPORT
====================================================== */
async function exportExcelReport() {
  const teamMap = await loadMainCSV();
  const all = needsSync() ? await fetchFromFirestore() : loadCache();

  const rows = [];

  for (const [user, wid] of teamMap.users ? teamMap.entries() : []) {}

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Earnings");

  XLSX.writeFile(wb, `Daily_Earnings_Report_${today()}.xlsx`);
}

/* ======================================================
   TABS
====================================================== */
function switchTab(tab) {
  const qTab = document.getElementById("tab-qualified");
  const tTab = document.getElementById("tab-transferred");
  const qPn  = document.getElementById("panel-qualified");
  const tPn  = document.getElementById("panel-transferred");

  if (tab === "qualified") {
    qTab.classList.add("active-tab");
    tTab.classList.remove("active-tab");
    qPn.style.display = "block";
    tPn.style.display = "none";
  } else {
    tTab.classList.add("active-tab");
    qTab.classList.remove("active-tab");
    tPn.style.display = "block";
    qPn.style.display = "none";
  }
}

/* ======================================================
   INIT
====================================================== */
window.addEventListener("DOMContentLoaded", () => {
  updateCountdown();
  setInterval(updateCountdown, 60000);

  document.getElementById("downloadExcel").onclick = exportExcelReport;
  document.getElementById("tab-qualified").onclick  = () => switchTab("qualified");
  document.getElementById("tab-transferred").onclick = () => switchTab("transferred");

  switchTab("qualified");

  if (needsSync()) {
    fetchFromFirestore().then(buildData);
  } else {
    buildData();
  }
});
</script>

<style>
body {
  font-family:"Segoe UI",Arial,sans-serif;
  background:#f8fafc;
  padding:20px;
}
h1 {
  text-align:center;
  color:#0f62fe;
}
#loading {
  text-align:center;
  color:#6b7280;
  margin-top:10px;
}
.summary-bar {
  text-align:center;
  font-size:16px;
  margin-top:10px;
}
#next-sync {
  text-align:center;
  margin-top:4px;
  margin-bottom:12px;
  color:#6b7280;
}

/* Tabs */
.tabs {
  display:flex;
  justify-content:center;
  margin:10px 0 15px 0;
}
.tab-btn {
  padding:8px 16px;
  border-radius:999px;
  border:1px solid #d1d5db;
  background:#e5e7eb;
  color:#374151;
  margin:0 4px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
}
.tab-btn.active-tab {
  background:#0f62fe;
  color:#ffffff;
  border-color:#0f62fe;
}

/* Common table style */
.table-wrap {
  width:95%;
  margin:0 auto 20px auto;
}
table {
  width:100%;
  background:#ffffff;
  border-radius:8px;
  border-collapse:collapse;
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
}
th,td {
  padding:10px;
  border-bottom:1px solid #e5e7eb;
}
th {
  background:#0f62fe;
  color:#ffffff;
}

/* Excel button */
.excel-btn {
  background:#0d9488;
  color:#ffffff;
  padding:8px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  margin:10px auto 15px auto;
  display:inline-block;
}
.excel-btn:hover {
  background:#0f766e;
}

/* Transferred filter */
.filter-bar {
  margin-bottom:10px;
  font-size:14px;
  color:#374151;
}
.filter-bar select {
  margin-left:6px;
  padding:4px 8px;
  border-radius:6px;
  border:1px solid #d1d5db;
  font-size:14px;
}
</style>
</head>

<body>

<h1>ðŸ’° Daily MTurk Earnings Monitor</h1>

<div id="loading">Loading Earningsâ€¦</div>

<div class="summary-bar" id="totalQualified"></div>
<div class="summary-bar" id="totalTransferred"></div>
<div id="next-sync"></div>

<div style="text-align:center;">
  <button id="downloadExcel" class="excel-btn">ðŸ“¥ Download Todayâ€™s Excel Report</button>
</div>

<div class="tabs">
  <button id="tab-qualified" class="tab-btn active-tab">Qualified Users (â‰¥ $8)</button>
  <button id="tab-transferred" class="tab-btn">Transferred (prevâ‰¥6 & currâ‰¤6)</button>
</div>

<!-- QUALIFIED PANEL -->
<div id="panel-qualified" class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Worker ID</th>
        <th>Current Earnings ($)</th>
        <th>Next Transfer Date</th>
      </tr>
    </thead>
    <tbody id="qualified-body"></tbody>
  </table>
</div>

<!-- TRANSFERRED PANEL -->
<div id="panel-transferred" class="table-wrap" style="display:none;">
  <div class="filter-bar">
    Filter by Transfer Date:
    <select id="transferDateFilter">
      <option value="">All Dates</option>
    </select>
  </div>
  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Worker ID</th>
        <th>Transferred Amount ($)</th>
        <th>Transferred Date</th>
      </tr>
    </thead>
    <tbody id="transferred-body"></tbody>
  </table>
</div>

</body>
</html>
